<!DOCTYPE html>

<html>

	<head>
		<title>Assignment 2</title>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset = "utf-8" >
		<link rel="stylesheet" href="style.css">
	</head>

	<body>
		<div id="map"></div>

		<script>
			var map;
			var coordinates;
			var me;
			var marker;
			var myIcon;
			var myInfoWindow;
			var xhr;
			var icon;

			function addPassenger(passenger) {

				icon = {

					url: "https://cdn4.iconfinder.com/data/icons/dot/128/taxi_passanger.png",
					scaledSize: new google.maps.Size(35, 35)
				}

				var tempMarker = new google.maps.Marker({

					position: new google.maps.LatLng(passenger.lat, passenger.lng),
					map: map,
					icon: icon
				})
			}

			function recievePositions(information) {

				doneParsing = JSON.parse(information);

				if (doneParsing.passengers.length == undefined){

					for (i = 0; i < doneParsing.vehicles.length; ++i) {

						addVehicle(doneParsing.vehicles[i]);
					}
				}

				else{

					for (i = 0; i < doneParsing.passengers.length; ++i) {

						addPassenger(doneParsing.passengers[i]);
					}					
				}
			}

			function sendPosition(pos) {

				coordinates = pos.coords;
				map.setCenter( {lat: coordinates.latitude, lng: coordinates.longitude});

				myIcon = {

					url: "https://cdn3.iconfinder.com/data/icons/map/500/around_me-128.png",
					scaledSize: new google.maps.Size(75, 75)
				}

				marker = new google.maps.Marker({

					position: new google.maps.LatLng(coordinates.latitude, coordinates.longitude),
					map: map,
					icon: myIcon
				})
				
				myInfoWindow = new google.maps.InfoWindow({
				content: "Hello!!!!"
				});

				myInfoWindow.open(map, marker);

				xhr = new XMLHttpRequest();
				xhr.open("Post", "https://jordan-marsh.herokuapp.com/rides", true);
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhr.onreadystatechange = function(){

					if(xhr.readyState == 4 && xhr.status == 200){

						recievePositions(xhr.responseText);
					}
				}

				xhr.send("username=oSsnoj2RLW&lat=" + coordinates.latitude + "&lng=" + coordinates.longitude);
			}



			function error(err) {
  			
  				console.warn(`ERROR(${err.code}): ${err.message}`);
			}

			function initMap() {

				map = new google.maps.Map(document.getElementById("map"), {
					center: {lat: 42.424, lng: -71.109},
					zoom: 15.5
				});				
			}

			navigator.geolocation.getCurrentPosition(sendPosition, error);

		</script>

		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCBAG9-NN0g7_kF0H4iigo8SWXN2cZl7iQ&callback=initMap"></script>
	</body>

</html>
